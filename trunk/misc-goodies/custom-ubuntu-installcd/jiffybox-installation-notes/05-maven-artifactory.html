<p>
    This guide explains how to use the server as a repository
    for the Apache Maven build tool.<br/>
    More precisely, I will show how to setup a private remote internal
    maven repository using the free Artifactory implementation.
</p>

<h2>Step 1 - Prepare environment</h2>
<p>
    Relevant config files:
    <ul>
        <li>/home/artifactory/artifactory_base/etc/artifactory.system.properties (datasource name, if using mysql)</li>
        <li>/home/artifactory/artifactory_base/etc/repo/filesystem-mysql/repo.xml (datasource, if using mysql)</li>
        <li>/home/artifactory/tomcat/conf/server.xml</li>
        <li>/etc/apache2/workers.properties (MountJk worker definition)</li>
        <li>/etc/apache2/sites-available/default (MountJk entry)</li>
    </ul>
</p>

<p>
    A separate artifactory-user will be created, who will control the server.<br/>
    The server software is installed in his home directory. This 
    encapsulation provides more flexibility and a higher level of 
    security.<br/>
    The artifactory web application will be deployed into a tomcat
    servlet container. <br/>
    How to setup a tomcat installation is described in this article:
    <a href="http://bytesare.us/cms/index.php/server-how-to/postgresql-and-jboss-as">
    PostgreSQL and JBoss AS</a>
</p>


<h3>Create artifactory user</h3>
<p>
    Set up a new user called artifactory:
    <pre>root@jiffybox # useradd -d /home/artifactory -m artifactory
root@jiffybox # usermod -a -G artifactory artifactory
root@jiffybox # chsh artifactory -s /bin/zsh</pre>

</p>

<h3>Setup a web container for the artifactory.war</h3>
<p>
    Create a tomcat instance as described in 
    <a href="http://bytesare.us/cms/index.php/server-how-to/postgresql-and-jboss-as">
    PostgreSQL and JBoss AS</a>, using the artifactory user and his home directory.<br/>
    
    Tomcat will is now installed here: <b>/home/artifactory/tomcat</b><br/>
    Make sure your tomcat instance is configured to use unique ports.
</p>

<h3>Access the app on the default web port</h3>
<p>
    If you want to access Artifactory on Port 80,
    mount it via JkMount to the apache HTTP server.<br/>
    <ol>
        <li>
            Define/Enable the Connector in your <b>&lt;ARTIFACTORY_TOMCAT&gt;/conf/server.xml</b>
            <pre>&lt;Connector port="8010" protocol="AJP/1.3" redirectPort="8443" address="localhost"/&gt;</pre>
        </li>
        <li>
            Add a worker that is used for the artifactory tomcat in: <b>/etc/apache2/workers.properties</b>
            <pre>worker.list=&lt;EXISTING-WORKER-IDS&gt;,artifactorytomcat
# ... &lt;EXISTING-WORKERS&gt; ...
worker.artifactorytomcat.type=ajp13
worker.artifactorytomcat.host=localhost
worker.artifactorytomcat.port=8010</pre>
        </li>
        <li>
            Mount the worker to "/artifactory* in: <b>/etc/apache2/sites-available/default</b>
            <pre>
&lt;VirtualHost *:80&gt;
  ServerName bytesare.us
  [...]
  # artifactory tomcat instance: (maven repo)
  JkMount /artifactory* artifactorytomcat
&lt;/VirtualHost&gt;
            </pre>
        </li>
    </ol>
</p>


<h2>Step 2 - Install and configure Artifactory</h2>
<p>
    Relevant config files:
    <ul>
        <li>/home/artifactory/bin/tomcat_base/bin/setenv.sh</li>
    </ul>
</p>

<h3>Unzip and deploy the software</h3>
<p>
    Download and unzip the artifactory software in the home directory:
    <pre>artifactory@jiffybox $ wget "http://sourceforge.net/projects/artifactory/files/artifactory/2.5.1.1/artifactory-2.5.1.1.zip/download" -O artifactory-2.5.1.1.zip
artifactory@jiffybox $ unzip artifactory-2.5.1.1.zip</pre>
    The contents of the archive were unpacked in the directory <i>artifactory-2.5.1.1</i>. This
    is the directory that needs to be configure as "artifactory.home". <br/>
    Let's create a link to highlight this fact:
    <pre>artifactory@jiffybox $ ln -s artifactory-2.5.1.1 artifactory_base</pre>
</p>
<p>
    Then link the war file contained in the artifactory_base to tomcat's webapps
    dir to deploy the war file. Set the "artifactory.home" Java variable in
    <b>/home/artifactory/bin/tomcat_base/bin/setenv.sh</b> to configure the
    base dir.
    <pre>export JAVA_OPTS="$JAVA_OPTS -Dartifactory.home=/home/artifactory/artifactory_base"'</pre>
</p>


<h3>Configure Artifactory to use MySql Database (Optional)</h3>
<p>
    By default, Artifactory uses the Apache-Derby in-memory database
    for the backend. Since we have MySql installed, we can save some memory
    (just a few megs) by using that database for artifactory.
</p>
<p>
    In this example, a separate database user will be created for the backend.<br/>
    (If you prefer, you can do this with the <a href="">PhpMyAdmin</a> tool.)
    <pre>root@jiffybox # mysql -u root -p
CREATE DATABASE artifactory CHARACTER SET utf8;
GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP,ALTER,INDEX on artifactory.* TO 'artifactory'@'localhost' IDENTIFIED BY 'password1';</pre>
</p>
<p>
    The next step installs the JDBC driver to the servlet container:
    <pre>artifactory@jiffybox $ cd /tmp/
artifactory@jiffybox $ wget "http://www.mysql.com/get/Downloads/Connector-J/mysql-connector-java-5.1.19.zip/from/http://gd.tuwien.ac.at/db/mysql/" -O mysql-connector-java-5.1.19.zip
artifactory@jiffybox $ unzip mysql-connector-java-5.1.19.zip
artifactory@jiffybox $ cp /tmp/mysql-connector-java-5.1.19/mysql-connector-java-5.1.19-bin.jar /home/artifactory/tomcat/lib/</pre>
</p>
<p>
    Then, create the datasource definition in the servlet container by adding this section to
    <b>/home/artifactory/artifactory_base/etc/repo/filesystem-mysql/repo.xml</b>:
    <pre>
&lt;!-- MySQL Datasource --&gt;
&lt;DataSources&gt;
    &lt;DataSource name="ds"&gt;
        &lt;param name="driver" value="com.mysql.jdbc.Driver"/&gt;
        &lt;param name="url" value="jdbc:mysql://localhost:3306/artifactory?useUnicode=true&amp;characterEncoding=UTF-8"/&gt;
        &lt;param name="user" value="artifactory"/&gt;
        &lt;param name="password" value="password1"/&gt;
        &lt;param name="databaseType" value="mysql"/&gt;
        &lt;!-- Unlimited when not specified --&gt;
        &lt;!--&lt;param name="maxPoolSize" value="80"/&gt;--&gt;
    &lt;/DataSource&gt;
&lt;/DataSources&gt;
    </pre>
</p>

<p>
    Finally, configure the artifactory instance to use this database.
    Register the datasource name in the artifactory configuration.<br/>
    Edit <b>/home/artifactory/artifactory_base/etc/artifactory.system.properties</b>
    and add/set this variable:
    <pre>artifactory.jcr.configDir=repo/filesystem-mysql</pre>
</p>



<h3>Start and test Artifactory</h3>
<p>
    by starting the servlet container with the formerly created tomcat-script:
    <pre>artifactory@jiffybox $ /etc/init.d/tomcat-artifactory.sh start</pre>
    Then, browse to the <a href="http://bytesare.us/artifactory">web console</a>, 
    login as 'admin' with 'password' (and change the password).
</p>


<h2>Step 3 - Configure the Maven client</h2>
<p>
    Relevant config files:
    <ul>
        <li>~/.m2/settings.xml</li>
        <li>pom.xml's</li>
    </ul>
</p>


<h3>Basic Configuration (Readonly Access)</h3>
<p>
    Maven client configuration is quite simple. Browse to the
    <a href="http://bytesare.us/artifactory">artifactory console</a>, and navigate
    to <i>Client Settings / Maven Settings</i>.<br/>
    Then click on <i>Generate Settings</i>, and paste the content into your
    <b>~/.m2/settings.xml</b>.<br/>
    You shoud now be able to run maven builds that use your repo!
</p>

<h3>Configuration for a deployer</h3>
<p>
    First, perform the basic configuration step. :-)<br/>
    Login to the <a href="http://bytesare.us/artifactory">artifactory console</a>
    <i>as admin</i>, and create a user.<br/>
    In this example "andre" is created as someone that is allowed to 
    deploy artifacts to the repository. (Read+Annotate+Deploy)
</p>
<p>
    Next, login with the deployer-user. Click on the link that is labelled
    with the users name, and enter the password.<br/>
    Copy the config snippet to your <b>~/.m2/settings.xml</b>.<br/>
    We will also set an ID to the server, so the pom's can later refer to this configuration.<br/>
    It should look like this:
    <pre>&lt;settings&gt;
  &lt;servers&gt;
      &lt;server&gt;
          &lt;id&gt;bytesare.us&lt;/id&gt; &lt;!-- referenced by the poms --&gt;
          &lt;username&gt;andre&lt;/username&gt;
          &lt;password&gt;\{DESede\}YOUR_CIPHER_PASSWORD==&lt;/password&gt;
      &lt;/server&gt;
  &lt;/servers&gt;
  ...
&lt;settings&gt;
    </pre>
    Then, we add this section to the <b>pom.xml</b> we want to deploy. <br/>
    (I defined it in my super-pom) 
    
    <pre>&lt;distributionManagement&gt;
    &lt;repository&gt;
        &lt;id&gt;bytesare.us&lt;/id&gt;&lt;!-- use credentials in settings.xml --&gt;
        &lt;url&gt;http://bytesare.us/artifactory/libs-release-local&lt;/url&gt;
    &lt;/repository&gt;
    &lt;snapshotRepository&gt;
        &lt;id&gt;bytesare.us&lt;/id&gt;&lt;!-- use credentials in settings.xml --&gt;
        &lt;url&gt;http://bytesare.us/artifactory/libs-snapshot-local&lt;/url&gt;
    &lt;/snapshotRepository&gt;
&lt;/distributionManagement&gt;
    </pre>
</p>
<p>
    This way, every developer can use the same pom.xml files, and needs to configure
    just his own settings.xml.<br/>
</p>
<p>
    Done, now try to deploy something with a simple
    <pre>mvn deploy:deploy</pre>
</p>

