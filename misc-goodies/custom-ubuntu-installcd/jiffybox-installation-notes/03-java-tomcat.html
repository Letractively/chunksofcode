
<h2>Step 1 - Java installation</h2>

<p>
    Describes how to integrate Oracle Java into an Ubuntu installation.<br/>
    You should consider installing just the JRE on a production system, except 
    when you need to compile Java code on that machine.
</p>
<p>
    Perform these steps to install Java and it will be configured as the
    default Java in your ubuntu system:
    <pre>
root@jiffybox # cd /usr/local/
root@jiffybox # # (I am not sure if this will work, you may have to download the file manually)
root@jiffybox # wget http://download.oracle.com/otn-pub/java/jdk/6u31-b04/jre-6u31-linux-x64.bin
root@jiffybox # /bin/sh jre-6u31-linux-x64.bin
root@jiffybox # ln -s jre1.6.0_31/ java # create link /usr/local/java -> jre1.6.0_31/
root@jiffybox # update-alternatives --install "/usr/bin/java" "java" "/usr/local/java/bin/java" 1
root@jiffybox # update-alternatives --set java "/usr/local/java/bin/java"
root@jiffybox # java -version # test installation
    </pre>
    
</p>


<h4>Configure Java in your environment</h4>

<p>
    To set JAVA_HOME environment variable globally, add this line to <b>/etc/profile</b>
    <pre>JAVA_HOME=/usr/local/java</pre>
    
    (Note that this will not affect running processes.)
    
</p>


<h2>Step 2 - Tomcat installation</h2>

<p>
I prefer to split the tomcat installation into a shared CATALINA_HOME 
directory and one CATALINA_BASE directory per tomcat instance.
</p>


<h4>HOME installation (Setup shared installation)</h4>

<p>
    In this example, <b> /opt/tomcat </b> is used as home.
    <pre>
root@jiffybox # cd /opt/
root@jiffybox # wget http://mirror.sti2.at/apache/tomcat/tomcat-7/v7.0.26/bin/apache-tomcat-7.0.26.zip
root@jiffybox # unzip apache-tomcat-7.0.26.zip
root@jiffybox # chown root:root -R apache-tomcat-7.0.26
root@jiffybox # chmod o-w -R apache-tomcat-7.0.26
root@jiffybox # ln -s apache-tomcat-7.0.26 tomcat
    </pre>
    
</p>


<h4>BASE installation (Setup an instance)</h4>

<p>
    In this example, <b> /home/testuser/tomcat_base </b> is used as base.<br/>
    If you want to create multiple instances, you might create a template first.
    
    <pre>
testuser@jiffybox $ mkdir /home/testuser/tomcat_base
testuser@jiffybox $ cd /home/testuser/tomcat_base
testuser@jiffybox $ mkdir {bin,conf,logs,temp,webapps,work}
testuser@jiffybox $ echo '# do whatever you want change in catalina.sh in this file.' >> bin/setenv.sh
testuser@jiffybox $ cp /opt/tomcat/conf/{server,web}.xml conf/
    </pre>
    
</p>

<p>
    Create a startup skript for the instance like this snippet below. <br/>
    I placed it at <b> /etc/init.d/testuser-tomcat-1.sh </b> :
    <pre>
#!/bin/sh
CATALINA_HOME=/opt/tomcat
CATALINA_BASE=/home/testuser/tomcat_base
/bin/sh $CATALINA_HOME/bin/catalina.sh $@
    </pre>
    
</p>

<p>
    Don't forget to allow the tomcat owner to execute the script:
    <pre>
root@jiffybox # chgrp andre /etc/init.d/tomcat-andre.sh
root@jiffybox # chmod 754 /etc/init.d/tomcat-andre.sh
    </pre>
    
</p>

<p>
    Finally, we want to test the installation with these statements:
    <pre>
testuser@jiffybox $ cp /data/shared/helloworld.war /home/testuser/tomcat_base/webapps/helloworld.war
testuser@jiffybox $ /etc/init.d/tomcat-andre.sh start
testuser@jiffybox $ wget http://localhost:8080/helloworld -O -
    </pre>
    
</p>


<h2>Step 3 - Use Tomcat Apps through Apache HTTP Server</h2>

<p>
    We want to reach the Tomcat apps on the standard Web port (80 for HTTP, 443 for
    HTTPS). To redirect the traffic through the HTTP server to the servlet container, 
    we use ModJK. <br/>
    This allows an installed app (more precisely, a context root) respond 
    via AJP protocol. The HTTP server may act as a load balancer in this case, but in 
    this example, I use only a single worker.<br/>
    For further information, try 
    <a href="http://tomcat.apache.org/tomcat-3.3-doc/mod_jk-howto.html">this</a> article.
</p>
<p>
    Relevant config files:
    <ul>
        <li>/etc/apache2/workers.properties</li>
        <li>/etc/apache2/apache2.conf</li>
        <li>/etc/apache2/sites-available/default</li>
        <li>&lt;TOMCAT_INSTANCE&gt;/conf/server.xml</li>
    </ul>
</p>
For example, you want the webapp http://<b>mydomain.ws:8080</b>/testapp to be 
available at http://<b>mydomain.ws</b>/testapp.


<h3>Install and configure mod_jk</h3>
<p>
    First, install the module:
    <pre>root@jiffybox # apt-get install libapache2-mod-jk</pre>
</p>
<p>
    Then, register and configure the module in apache configuration.<br/>
    Add the following snippet to file <b> /etc/apache2/apache2.conf </b> :
    
    <pre>
JkWorkersFile /etc/apache2/workers.properties
JkLogFile /var/log/apache2/mod_jk.log
JkShmFile /var/log/apache2/mod_jk.shm
JkLogLevel info
JkLogStampFormat "[%a %b %d %H:%M:%S %Y] "
    </pre>
    
</p>

<p>
    After this, we will define a worker as mentioned above.<br/>
    Create/Edit file <b>/etc/apache2/apache2.conf</b> and insert following entries:
    <pre>
# define one single worker in this example:
worker.list=myfirstworker
# configure the worker:
worker.myfirstworker.type=ajp13
worker.myfirstworker.host=localhost
worker.myfirstworker.port=8009
    </pre>
</p>

<p>
    Now it's time to tell the apache config to redirect the requests incoming to
    the /helloworld contextroot to our ajp worker.<br/>
    Edit your <b>/etc/apache2/sites-available/default</b> file:
    <pre>
# (this is the host section we want to use for the mapping)
&lt;VirtualHost *:80&gt;
    ServerName mydomain.ws
    # [... blah blah ...]
    # define the mapping:
    JkMount /helloworld* myfirstworker
&lt;/VirtualHost&gt;
    </pre>
    
    
</p>


<h3>Configure Tomcat</h3>

<p>
    Finally, we need to configure the Tomcat instance to enable the AJP connector.
    Make sure the following element is set in <b> /home/testuser/tomcat_base/conf/server.xml </b> :
    <pre>&lt;Connector port="8009" protocol="AJP/1.3" redirectPort="8443" /&gt;</pre>
    
</p>

<p>
    If you do not want tomcat to response any HTTP requests incoming to (default) port
    8080, you can comment out the HTTP connector in the same file:
    
    <pre>&lt;!--
    &lt;Connector port="8080" protocol="HTTP/1.1" redirectPort="8443" /&gt;
--&gt;
    </pre>
    
</p>
<p>
    Congratulations, you should now be able to browse your testapplication through
    http://mydomain.ws/helloworld after restarting the services with:
    <pre>
root@jiffybox # /etc/init.d/apache2 restart
root@jiffybox # /etc/init.d/testuser-tomcat-1.sh stop
root@jiffybox # /etc/init.d/testuser-tomcat-1.sh start
    </pre>
</p>


